

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Poppins', sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #ffffff;
        text-align: center;
        padding: 20px;
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        margin-bottom: 30px;
        position: relative;
      }

      .logo-container {
        flex: 1;
        text-align: center;
      }

      .logo {
        max-width: 400px;
        height: auto;
      }

      .admin-container {
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .admin-btn {
        background-color: #1565c0;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        text-decoration: none;
        display: inline-block;
      }

      .admin-btn:hover {
        background-color: #0d47a1;
      }

      .footer {
        margin-top: 40px;
        padding: 20px;
        text-align: center;
        font-style: italic;
        color: #1565c0;
        border-top: 1px solid #eee;
      }

      h1 {
        font-weight: 600;
        font-size: 32px;
        margin-bottom: 20px;
        text-transform: uppercase;
      }

      .filters {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      select, input {
        padding: 10px;
        font-size: 16px;
        width: 250px;
        font-family: 'Poppins', sans-serif;
      }

      .profile-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
        justify-content: center;
      }

      .profile-box {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        width: 300px;
        text-align: left;
        background-color: #f9f9f9;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .profile-box img {
        width: 100%;
        height: 200px;
        object-fit: contain;
        border-radius: 10px;
        margin-bottom: 10px;
        background-color: #f5f5f5;
      }

      .profile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .profile-type {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
      }

      .rf-type {
        background-color: #e3f2fd;
        color: #1565c0;
        margin-right: 5px;
      }

      .grant-type {
        background-color: #ffebee;
        color: #c62828;
      }

      .gif-type {
        background-color: #e8f5e9;
        color: #2e7d32;
      }

      .profile-info {
        font-size: 14px;
        margin-bottom: 5px;
      }

      .profile-info strong {
        color: #1565c0;
      }

      .project-section {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #1565c0;
      }

      .project-header {
        font-size: 18px;
        color: #1565c0;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .project-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .project-name {
        flex: 2;
      }

      .project-date {
        flex: 1;
        text-align: right;
        color: #2e7d32;
        font-weight: 500;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 15px;
        width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 36px;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        background-color: #f5f5f5;
        border-radius: 25px;
        color: #333;
      }

      .close-button:hover {
        background-color: #e0e0e0;
      }

      @media screen and (max-width: 768px) {
        .filters {
          flex-direction: column;
          align-items: center;
        }

        .profile-box {
          width: 90%;
        }

        .modal-content {
          width: 95%;
          margin: 20px;
        }

        .logo {
          max-width: 300px;
        }

        .admin-container {
          position: relative;
          top: 0;
          right: 0;
          margin-top: 20px;
        }
      }

     .view-toggle {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .view-btn {
        padding: 8px 20px;
        border: 1px solid #1565c0;
        background-color: white;
        color: #1565c0;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Poppins', sans-serif;
      }

      .view-btn.active {
        background-color: #1565c0;
        color: white;
      }

      .analytics-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background-color: #e3f2fd;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #1565c0;
      }

      .stat-label {
        color: #555;
        margin-top: 5px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .chart-card {
        background-color: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .chart-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
        display: flex;
        align-items: center;
      }

      .chart-icon {
        margin-right: 8px;
        color: #1565c0;
      }

      .district-bar {
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        margin-bottom: 8px;
        position: relative;
        overflow: hidden;
      }

      .district-fill {
        height: 100%;
        background-color: #1565c0;
        border-radius: 10px;
      }

      .district-label {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 5px;
      }

.year-chart {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  height: 200px;
  padding-top: 20px;
}

.year-bar {
  background-color: #1976d2;
  border-radius: 4px 4px 0 0;
  width: 30px;
  transition: height 0.3s ease;
}

.year-bar:hover {
  background-color: #0d47a1;
}

.year-label {
  margin-top: 8px;
  text-align: center;
  font-size: 12px;
}
      @media screen and (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
        
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <div class="logo-container">
        <img src="https://drive.google.com/thumbnail?id=1AEEWccjf_sMoXJgAaYIPZZm5rM-OCFe2" alt="We'RE SL Logo" class="logo">
      </div>
      <div class="admin-container">
        <a href="https://script.google.com/macros/s/AKfycbzn6wewwR_SMXm_-ZQNGP7sifEFLD0ryVpuJojIvIv7WFIH9VJQKTrr__B2RtoFancTVQ/exec" target="_blank" class="admin-btn">
          Add Donation Details
        </a>
      </div>
    </div>
    <h1>We'RE SL Database</h1>
    <div class="view-toggle">
  <button id="profileViewBtn" class="view-btn active">Profile View</button>
  <button id="analyticsViewBtn" class="view-btn">Analytics Dashboard</button>
</div>

<div id="analyticsContainer" style="display: none;" class="analytics-container"></div>
    <!-- Add this to your filters div -->
<div class="filters">
  <select id="districtFilter" onchange="filterProfiles()">
    <option value="">All Districts</option>
  </select>
  <select id="typeFilter" onchange="filterProfiles()">
    <option value="">All Types</option>
    <option value="RF">RF Loan</option>
    <option value="GRANT">Grant</option>
  </select>
  <select id="yearFilter" onchange="filterProfiles()">
    <option value="">All Years</option>
  </select>
  <select id="armsFilter" onchange="filterProfiles()">
    <option value="">All Arms</option>
  </select>
  <input type="text" id="searchInput" placeholder="Search by name..." oninput="filterProfiles()">
</div>

    <!-- Add this below the filters div to show the count -->
    <div style="margin: 15px 0; font-weight: 500;">
      <span id="profileCount">0</span> profiles found
    </div>

    <div class="profile-container" id="profileContainer"></div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
      </div>
    </div>
  <div class="footer">
        <strong>Galatians 6:9</strong> ðŸ™Œ
        <p><em>"Let us not grow weary in doing good, for at the proper time we will reap a harvest if we do not give up."</em></p>
      </div>

<!-- Add this after your profile container -->
<div id="analyticsContainer" style="display: none;" class="analytics-container"></div>


    <script>
  let allProfiles = [];
  let profileYears = new Set();

function initialize() {
  google.script.run.withSuccessHandler(handleProfiles).getAllProfiles();
  
  // Set up event listeners for view switching
  document.getElementById('profileViewBtn').addEventListener('click', function() {
    switchView('profile');
  });
  
  document.getElementById('analyticsViewBtn').addEventListener('click', function() {
    switchView('analytics');
  });
}

function handleProfiles(profiles) {
  // Add error handling and filtering for null/undefined values
  allProfiles = profiles.filter(p => p && p.Name && typeof p === 'object');
  
  // Extract years from profiles
  extractYears();
  
  // Populate filters
  populateDistrictFilter();
  populateYearFilter();
  populateArmsFilter(); // Add this line
  
  // Display profiles
  displayProfiles(allProfiles);
  updateProfileCount(allProfiles.length);
}

function extractYears() {
  profileYears.clear();
  profileYears.add("Unidentified"); // Add "Unidentified" option
  
  allProfiles.forEach(profile => {
    // Check RF loans
    if (profile.RF_Loan) {
      const years = extractYearsFromString(profile.RF_Loan);
      if (years.length === 0 && profile.RF_Loan.trim() !== '') {
        // RF loan exists but no year found
        profileYears.add("Unidentified");
      } else {
        years.forEach(year => profileYears.add(year));
      }
    }
    
    // Check Grant projects
    if (profile.GRANT_Cur_Prj) {
      const years = extractYearsFromString(profile.GRANT_Cur_Prj);
      if (years.length === 0 && profile.GRANT_Cur_Prj.trim() !== '') {
        // Grant exists but no year found
        profileYears.add("Unidentified");
      } else {
        years.forEach(year => profileYears.add(year));
      }
    }
  });
}

function extractYearsFromString(str) {
  if (!str) return [];
  
  const years = [];
  // Look for date patterns like [DD-MM-YYYY]
  const regex = /\[(\d{2}-\d{2}-(\d{4}))\]/g;
  let match;
  
  while ((match = regex.exec(str)) !== null) {
    years.push(match[2]);
  }
  
  return years;
}

  function populateDistrictFilter() {
    const districts = [...new Set(allProfiles.map(p => p.District).filter(Boolean))];
    const select = document.getElementById('districtFilter');
    
    // Clear existing options first
    select.innerHTML = '<option value="">All Districts</option>';
    
    districts.sort().forEach(district => {
      const option = document.createElement('option');
      option.value = district;
      option.textContent = district;
      select.appendChild(option);
    });
  }

function populateYearFilter() {
  const select = document.getElementById('yearFilter');
  select.innerHTML = '<option value="">All Years</option>';
  
  // Get array of years, sorted with "Unidentified" at the end
  const sortedYears = [...profileYears].filter(y => y !== "Unidentified").sort((a, b) => b - a);
  if (profileYears.has("Unidentified")) {
    sortedYears.push("Unidentified");
  }
  
  // Create options
  sortedYears.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });
}

function filterProfiles() {
  const district = document.getElementById('districtFilter').value;
  const type = document.getElementById('typeFilter').value;
  const year = document.getElementById('yearFilter').value;
  const arms = document.getElementById('armsFilter').value;
  const search = document.getElementById('searchInput').value.toLowerCase();

  let filtered = allProfiles;

  if (district) {
    filtered = filtered.filter(p => p.District === district);
  }

  if (type) {
    filtered = filtered.filter(p => {
      if (type === 'RF') {
        return Boolean(p.RF_Loan || p.RF_Paid_History);
      } 
      else if (type === 'GRANT') {
        return Boolean(p.GRANT);
      }
      return true;
    });
  }

  if (year) {
    filtered = filtered.filter(p => {
      // Special case for "Unidentified"
      if (year === "Unidentified") {
        // Has RF loan or grant but no year information
        const hasRFNoYear = p.RF_Loan && !p.RF_Loan.includes('[');
        const hasGrantNoYear = p.GRANT_Cur_Prj && !p.GRANT_Cur_Prj.includes('[');
        return hasRFNoYear || hasGrantNoYear;
      }
      
      // Normal year filtering
      const hasRFYear = p.RF_Loan && p.RF_Loan.includes(`-${year}]`);
      const hasGrantYear = p.GRANT_Cur_Prj && p.GRANT_Cur_Prj.includes(`-${year}]`);
      
      return hasRFYear || hasGrantYear;
    });
  }

  if (arms) {
    filtered = filtered.filter(p => 
      p.ArmsArray && p.ArmsArray.includes(arms)
    );
  }

  if (search) {
    filtered = filtered.filter(p => 
      (p.Name || '').toLowerCase().includes(search) ||
      (p.District || '').toLowerCase().includes(search)
    );
  }

  displayProfiles(filtered);
  updateProfileCount(filtered.length);
}

  function updateProfileCount(count) {
    document.getElementById('profileCount').textContent = count;
  }

function populateArmsFilter() {
  const allArms = new Set();
  
  // Collect all unique Arms values
  allProfiles.forEach(profile => {
    if (profile.ArmsArray && profile.ArmsArray.length > 0) {
      profile.ArmsArray.forEach(arm => allArms.add(arm));
    }
  });
  
  const select = document.getElementById('armsFilter');
  select.innerHTML = '<option value="">All Arms</option>';
  
  // Create options
  Array.from(allArms).sort().forEach(arm => {
    const option = document.createElement('option');
    option.value = arm;
    option.textContent = arm;
    select.appendChild(option);
  });
}

function displayProfiles(profiles) {
  const container = document.getElementById('profileContainer');
  container.innerHTML = '';

  profiles.forEach(profile => {
    if (!profile || !profile.Name) return;

    const box = document.createElement('div');
    box.className = 'profile-box';
    
    const hasRF = Boolean(profile.RF_Loan || profile.RF_Paid_History);
    const hasGrant = Boolean(profile.GRANT);
    const hasGIF = Boolean(profile.GIFor);

    box.innerHTML = `
      <img src="https://drive.google.com/thumbnail?id=${getImageId(profile.Image)}" alt="${profile.Name}">
      <div class="profile-header">
        <h3>${profile.Name}</h3>
        <div>
          ${hasRF ? '<span class="profile-type rf-type">RF</span>' : ''}
          ${hasGrant ? '<span class="profile-type grant-type">GRANT</span>' : ''}
          ${hasGIF ? '<span class="profile-type gif-type">GIF</span>' : ''}
        </div>
      </div>
      <div class="profile-info"><strong>District:</strong> ${profile.District || 'N/A'}</div>
      <div class="profile-info"><strong>Age:</strong> ${profile.Age || 'N/A'}</div>
      <div class="profile-info"><strong>Occupation:</strong> ${profile.Occupation || 'N/A'}</div>
      ${profile.ArmsArray && profile.ArmsArray.length > 0 ? 
  `<div class="profile-info"><strong>Arms:</strong> ${profile.ArmsArray.join(', ')}</div>` : ''}
    `;

    box.onclick = () => showModal(profile);
    container.appendChild(box);
  });
}

      function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
          const parts = dateStr.split('-');
          if (parts.length === 3) {
            const [day, month, year] = parts;
            const date = new Date(`${year}-${month}-${day}`);
            
            if (!isNaN(date.getTime())) {
              return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
            }
          }
          return dateStr;
        } catch (e) {
          return dateStr;
        }
      }

      function formatProjectString(projectStr) {
        if (!projectStr) return { name: 'N/A', amount: '', date: '' };
        
        const match = projectStr.match(/(.+?)\s*\((\d+,*\d*)\)\s*\[([\d-]+)\]/);
        if (match) {
          return {
            name: match[1].trim(),
            amount: match[2].trim(),
            date: formatDate(match[3].trim())
          };
        }
        return { name: projectStr, amount: '', date: '' };
      }

      function parseProjects(projectString) {
        if (!projectString) return [];
        return projectString.split('+').map(project => formatProjectString(project.trim()));
      }

      function formatPaidHistory(historyStr) {
        if (!historyStr) return [];
        
        return historyStr.split('+').map(entry => {
          const match = entry.trim().match(/(\d+,*\d*)\s*\[([\d-]+)\]/);
          if (match) {
            return {
              amount: match[1].trim(),
              date: formatDate(match[2].trim())
            };
          }
          return { amount: '', date: '' };
        });
      }


      function showModal(profile) {
        const modal = document.getElementById('modal');
        const content = document.getElementById('modalContent');
        
        const hasRF = profile.RF_Loan || profile.RF_Paid_History;
        const hasGrant = profile.GRANT;
        
        let projectsHtml = '';
        
        // RF Projects Section
        if (hasRF) {
          const currentProject = profile.RF_Cur_Prj ? formatProjectString(profile.RF_Cur_Prj) : null;
          const loanProjects = parseProjects(profile.RF_Loan);
          const paidHistory = profile.RF_Paid_History ? formatPaidHistory(profile.RF_Paid_History) : [];

          
          projectsHtml += `
            <div class="project-section">
              <div class="project-header">RF Projects</div>
              
                ${currentProject ? `
                  <div class="project-details" style="flex-direction: column;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Pending RF projects</div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; margin-left: 20px;">
                      <span>${currentProject.name}</span>
                    </div>
                  </div>
                ` : ''}


              
                <div class="project-details" style="flex-direction: column;">
                  <strong>Total distributed Loans</strong>
                  ${loanProjects.map(project => `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; margin-left: 20px;">
                      <span>${project.name}</span>
                      <span style="margin-left: 10px;">
                        Rs. ${project.amount}
                        ${project.date ? `<span style="color: #2e7d32"> (${project.date})</span>` : ''}
                      </span>
                    </div>
                  `).join('')}
                </div>

              
              ${paidHistory.length ? `
                <div class="project-details" style="flex-direction: column;">
                  <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">RF Paid History</div>
                  ${paidHistory.map(payment => `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; margin-left: 20px;">
                      <span style="color: #2e7d32">${payment.date}</span>
                      <span style="margin-left: 10px;">Rs. ${payment.amount}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}






              
              
              ${profile.Com_prjs ? `
                <div class="project-details" style="margin-top: 10px;">
                  <div class="project-name">
                    <strong>Completed Projects:</strong>
                    <div style="margin-left: 20px; margin-top: 5px;">
                      ${profile.Com_prjs}
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }
                // Grant Projects Section
        if (hasGrant) {
            const currentProjects = parseProjects(profile.GRANT_Cur_Prj);
            
            projectsHtml += `
              <div class="project-section">
                <div class="project-header">Grant Projects</div>
                ${currentProjects.length > 0 ? `
                  <div class="project-details" style="flex-direction: column;">
                    <strong>Current Projects:</strong>
                    ${currentProjects.map(project => `
                      <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>${project.name}</span>
                        <span>
                          ${project.amount ? `Rs. ${project.amount}` : ''} 
                          ${project.date ? `<span style="color: #2e7d32"> (${project.date})</span>` : ''}
                        </span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                
                <div class="project-details">
                  <div class="project-name">
                    <strong>Total Grant Amount:</strong> Rs. ${profile.GRANT}
                  </div>
                </div>
              </div>
            `;

            // **Add "Give It Forward" section**
            if (profile.GIFor && profile.GIFor.trim() !== '') {
                // Split the GIFor string into individual descriptions and dates
                const giforEntries = profile.GIFor.split(/\s*\+\s*/g); // Split by " + "
                
                // Format the entries as "date: description"
                const formattedGIFor = giforEntries.map(entry => {
                    const match = entry.match(/(.*)\s*\[\s*(\d{2}-\d{2}-\d{4})\s*\]/);
                    if (match) {
                        const description = match[1].trim();
                        const date = match[2].trim();
                        return `${date}: ${description}`;
                    }
                    return entry; // In case the entry does not match the expected format
                }).join('<br/>');

                projectsHtml += `
                  <div class="project-section">
                    <div class="project-header" style="color: green;">Give It Forward</div>
                    <div class="project-details">
                      <div class="project-description">${formattedGIFor}</div>
                    </div>
                  </div>
                `;
            }
        }


        // Rest of the modal content remains the same
        content.innerHTML = `
          <img src="https://drive.google.com/thumbnail?id=${getImageId(profile.Image)}" 
              style="width: 200px; height: 200px; object-fit: contain; background-color: #f5f5f5; border-radius: 10px; margin-bottom: 20px;">
          <h2>${profile.Name}</h2>
          <div style="text-align: left; margin-top: 20px;">
            <p><strong>Registration ID:</strong> ${profile.Reg_ID}</p>
            <p><strong>District:</strong> ${profile.District}</p>
            <p><strong>Age:</strong> ${profile.Age}</p>
            <p><strong>Address:</strong> ${profile.Address}</p>
            <p><strong>NIC:</strong> ${profile.NIC}</p>
            <p><strong>Contact:</strong> ${profile.contact}</p>
            <p><strong>Family Members:</strong></p>
            <p><strong>Arms:</strong> ${profile.ArmsArray && profile.ArmsArray.length > 0 ? profile.ArmsArray.join(', ') : 'N/A'}</p>
            <ul style="margin-left: 20px;">
              <li>Total Children: ${profile.total_children || '0'}</li>
              <li>School Kids: ${profile.school_kids || '0'}</li>
              <li>Others: ${profile.others || '0'}</li>
            </ul>
            <p><strong>Occupation:</strong> ${profile.Occupation || 'N/A'}</p>
            
            ${projectsHtml}
            
            ${profile.Description ? `
              <div class="project-section">
                <div class="project-header">Additional Information</div>
                <p>${profile.Description}</p>
              </div>
            ` : ''}
          </div>
        `;

        modal.style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('modal').style.display = 'none';
      }

      function getImageId(url) {
        if (!url) return '';
        const match = url.match(/[-\w]{25,}/);
        return match ? match[0] : '';
      }

      window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) {
          closeModal();
        }
      }

      window.onload = initialize;

      // View switching functionality
      function switchView(view) {
        console.log("Switching to view:", view);
        const profileContainer = document.getElementById('profileContainer');
        const analyticsContainer = document.getElementById('analyticsContainer');
        const profileViewBtn = document.getElementById('profileViewBtn');
        const analyticsViewBtn = document.getElementById('analyticsViewBtn');
        const filtersSection = document.querySelector('.filters');
        const profileCountSection = document.getElementById('profileCount').parentElement;
        
        if (view === 'profile') {
          profileContainer.style.display = 'flex';
          analyticsContainer.style.display = 'none';
          profileViewBtn.classList.add('active');
          analyticsViewBtn.classList.remove('active');
          filtersSection.style.display = 'flex';
          profileCountSection.style.display = 'block';
        } else {
          profileContainer.style.display = 'none';
          analyticsContainer.style.display = 'block';
          profileViewBtn.classList.remove('active');
          analyticsViewBtn.classList.add('active');
          filtersSection.style.display = 'none';
          profileCountSection.style.display = 'none';
          
          // Populate analytics data when switching to this view
          populateAnalytics();
        }
      }

      function populateAnalytics() {
        console.log("Populating analytics with profiles:", allProfiles.length);
        // Calculate statistics from allProfiles data
        const stats = calculateStats(allProfiles);
        renderAnalyticsDashboard(stats);
      }

      function calculateStats(profiles) {
        // Count total profiles
        const totalProfiles = profiles.length;
        
        // Count RF loans and grants
        const rfLoans = profiles.filter(p => p.RF_Loan || p.RF_Paid_History).length;
        const grants = profiles.filter(p => p.GRANT).length;
        
        // Count profiles by district
        const districtCounts = {};
        profiles.forEach(profile => {
          if (profile.District) {
            districtCounts[profile.District] = (districtCounts[profile.District] || 0) + 1;
          }
        });
        
        // Get top 4 districts and group the rest as "Other"
        const sortedDistricts = Object.entries(districtCounts)
          .sort((a, b) => b[1] - a[1]);
        
        const topDistricts = {};
        let otherCount = 0;
        
        sortedDistricts.forEach((entry, index) => {
          if (index < 4) {
            topDistricts[entry[0]] = entry[1];
          } else {
            otherCount += entry[1];
          }
        });
        
        if (otherCount > 0) {
          topDistricts['Other'] = otherCount;
        }
        
        // Calculate yearly data
        const yearData = {};
        const currentYear = new Date().getFullYear();
        
        // Initialize last 5 years with zero counts
        for (let i = 0; i < 5; i++) {
          const year = currentYear - i;
          yearData[year] = 0;
        }
        
        profiles.forEach(profile => {
          // Extract years from RF loans
          if (profile.RF_Loan) {
            const years = extractYearsFromString(profile.RF_Loan);
            years.forEach(year => {
              if (yearData[year] !== undefined) {
                yearData[year] += 1;
              }
            });
          }
          
          // Extract years from grants
          if (profile.GRANT_Cur_Prj) {
            const years = extractYearsFromString(profile.GRANT_Cur_Prj);
            years.forEach(year => {
              if (yearData[year] !== undefined) {
                yearData[year] += 1;
              }
            });
          }
        });
        
        // Convert to array and sort by year
        const yearlyData = Object.entries(yearData)
          .map(([year, count]) => ({ year, count }))
          .sort((a, b) => a.year - b.year);
        
        console.log("Calculated stats:", {
          totalProfiles,
          rfLoans,
          grants,
          districts: topDistricts,
          yearlyData
        });
        
        return {
          totalProfiles,
          rfLoans,
          grants,
          districts: topDistricts,
          yearlyData
        };
      }

      function renderAnalyticsDashboard(stats) {
        console.log("Rendering dashboard with stats:", stats);
        const container = document.getElementById('analyticsContainer');
        
        let html = `
          <h2 style="color: #1565c0; font-size: 24px; margin-bottom: 20px; font-weight: 600;">Database Overview</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">${stats.totalProfiles}</div>
              <div class="stat-label">Total Profiles</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.rfLoans}</div>
              <div class="stat-label">RF Loans</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.grants}</div>
              <div class="stat-label">Grants</div>
            </div>
          </div>
          
          <div class="charts-grid">
            <div class="chart-card">
              <div class="chart-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chart-icon">
                  <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                District Distribution
              </div>
              <div class="district-chart">
        `;
        
        // Add district bars
        Object.entries(stats.districts).forEach(([district, count]) => {
          const percentage = (count / stats.totalProfiles) * 100;
          html += `
            <div class="district-label">
              <span>${district}</span>
              <span>${count} (${percentage.toFixed(1)}%)</span>
            </div>
            <div class="district-bar">
              <div class="district-fill" style="width: ${percentage}%"></div>
            </div>
          `;
        });
        
        html += `
              </div>
            </div>
            
            <div class="chart-card">
              <div class="chart-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chart-icon">
                  <rect x="2" y="12" width="4" height="8"></rect>
                  <rect x="10" y="8" width="4" height="12"></rect>
                  <rect x="18" y="4" width="4" height="16"></rect>
                </svg>
                Yearly Growth
              </div>
              <div class="year-chart" style="display: flex; justify-content: space-around; align-items: flex-end; height: 200px; padding-top: 20px;">
        `;
        
        // Find maximum count for scaling
        const maxCount = Math.max(...stats.yearlyData.map(d => d.count));
        
        // Add year bars
        stats.yearlyData.forEach(item => {
          const barHeight = maxCount > 0 ? (item.count / maxCount) * 150 : 0;
          html += `
            <div style="display: flex; flex-direction: column; align-items: center; margin: 0 5px;">
              <div class="year-bar" style="height: ${barHeight}px; width: 30px; background-color: #1976d2; border-radius: 4px 4px 0 0;"></div>
              <div class="year-label" style="margin-top: 8px; text-align: center;">${item.year}<br>${item.count}</div>
            </div>
          `;
        });
        
        html += `
              </div>
            </div>
          </div>
        `;
        
        container.innerHTML = html;
      }

     
    </script>
  </body>
</html>	